Формат сообщений CAN
====================



+-------------------+-------------------------------+-----------+----------+-----------------+---------------------+---------------------------------------------------+-------------------+
| Сообщение         | Описание                      | Инициатор | Абонент  | Адрес (CAN_ID)  | Длина  сообщ., байт | Данные                                            | Ответ             |
+===================+===============================+===========+==========+=================+=====================+===================================================+===================+
| LED0_ON           | Включить LED0                 | ПУ        | Терминал | АДРЕС_ТЕРМИНАЛА | 1                   | Byte0[7:0]: код операции: 01h                     | -                 |
+-------------------+-------------------------------+-----------+----------+-----------------+---------------------+---------------------------------------------------+-------------------+
| LED0_OFF          | Выключить LED0                | ПУ        | Терминал | АДРЕС_ТЕРМИНАЛА | 1                   | Byte0[7:0]: код операции: 02h                     | -                 |
+-------------------+-------------------------------+-----------+----------+-----------------+---------------------+---------------------------------------------------+-------------------+
| LED1_ON           | Включить LED1                 | ПУ        | Терминал | АДРЕС_ТЕРМИНАЛА | 1                   | Byte0[7:0]: код операции: 03h                     | -                 |
+-------------------+-------------------------------+-----------+----------+-----------------+---------------------+---------------------------------------------------+-------------------+
| LED1_OFF          | Выключить LED0                | ПУ        | Терминал | АДРЕС_ТЕРМИНАЛА | 1                   | Byte0[7:0]: код операции: 04h                     | -                 |
+-------------------+-------------------------------+-----------+----------+-----------------+---------------------+---------------------------------------------------+-------------------+
| ADDRESS_REQ       | Запрос адреса всех            | ПУ        | Всем     | 000h            | 1                   | Byte0[7:0]: код операции: 05h                     | -                 |
|                   | устройств подключенных к шине |           |          |                 |                     |                                                   |                   |
+-------------------+-------------------------------+-----------+----------+-----------------+---------------------+---------------------------------------------------+-------------------+
| STATUS_REQ        | Запрос статуса                | ПУ        | Терминал | АДРЕС_ТЕРМИНАЛА | 1                   | Byte0[7:0]: код операции: 06h                     | STATUS_RESP       |
+-------------------+-------------------------------+-----------+----------+-----------------+---------------------+---------------------------------------------------+-------------------+
| STATUS_RESP       | Статус устройства             | Терминал  | ПУ       | 3FFh            | 8                   | Byte0[7:0]: код операции: 07h                     |                   |
|                   |                               |           |          |                 |                     |                                                   |                   |
|                   |                               |           |          |                 |                     | Byte1[0]: Статус LED0 (1 – включен, 0 — выключен) |                   |
|                   |                               |           |          |                 |                     |                                                   |                   |
|                   |                               |           |          |                 |                     | Byte1[1]: Статус LED1 (1 – включен, 0 — выключен) |                   |
|                   |                               |           |          |                 |                     |                                                   |                   |
|                   |                               |           |          |                 |                     | Byte1[7:2]: Зарезервировано: XXh                  |                   |
|                   |                               |           |          |                 |                     |                                                   |                   |
|                   |                               |           |          |                 |                     | Byte2..Byte7: Зарезервировано: XXh                | -                 |
+-------------------+-------------------------------+-----------+----------+-----------------+---------------------+---------------------------------------------------+-------------------+
| LAST_CARD_ID_REQ  | Запрос ID последней карты     | ПУ        | Терминал | АДРЕС_ТЕРМИНАЛА | 1                   | Byte0[7:0]: код операции: 08h                     | LAST_CARD_ID_RESP |
+-------------------+-------------------------------+-----------+----------+-----------------+---------------------+---------------------------------------------------+-------------------+
| LAST_CARD_ID_RESP | ID последней карты            | Терминал  | ПУ       | 3FFh            | 8                   | Byte0[7:0]: код операции: 09h                     |                   |
|                   |                               |           |          |                 |                     |                                                   |                   |
|                   |                               |           |          |                 |                     | Byte1..Byte7: ID карты                            | -                 |
+-------------------+-------------------------------+-----------+----------+-----------------+---------------------+---------------------------------------------------+-------------------+
| NEW_CARD          | Новая карта прочитана         | Терминал  | ПУ       | 3FFh            | 8                   | Byte0[7:0]: код операции: 0Ah                     |                   |
|                   |                               |           |          |                 |                     |                                                   |                   |
|                   |                               |           |          |                 |                     | Byte1..Byte7: ID карты                            | -                 |
+-------------------+-------------------------------+-----------+----------+-----------------+---------------------+---------------------------------------------------+-------------------+

Преобразование UART - CAN - UART
================================

Каждое сообщение CAN транслируется в сообщение UART и наооборот. Сообщение начинается со старт байта.

+------------+----------+-----------------+----------+------------------------------------------------+
| Поле       | Смещение | Количество байт | Значение | Опиcание                                       |
+============+==========+=================+==========+================================================+
| Старт байт | 0x00     | 1               | 0xF0     | Старт байт указывает на начало сообщения       |
+------------+----------+-----------------+----------+------------------------------------------------+
| RESERVED1  | 0x01     | 1               | 0x0[X1]  | X1 - Зарезервировано                           |
+------------+----------+-----------------+----------+------------------------------------------------+
| STD_ID     | 0x02     | 4               | 0x0[X2]  | X2 - младшая тетрада младшего байта STD_ID     |
|            |          |                 |          |                                                |
|            |          |                 | 0x0[X3]  | X3 - старшая тетрада младшего байта STD_ID     |
|            |          |                 |          |                                                |
|            |          |                 | 0x0[X4]  | X4 - младшая тетрада старшего байта STD_ID     |
|            |          |                 |          |                                                |
|            |          |                 | 0x0[X5]  | X5 - старшая тетрада старшего байта STD_ID     |
+------------+----------+-----------------+----------+------------------------------------------------+
| RESERVED2  | 0x06     | 10              | 0x0[X6]  | X6 ... X15 - зарезервировано                   |
|            |          |                 | ...      |                                                |
|            |          |                 | 0x[X15]  |                                                |
+------------+----------+-----------------+----------+------------------------------------------------+
| DLС        | 0x10     | 1               | 0x0[X16] | X16 - размер исходного CAN сообщения (1-8)     |
+------------+----------+-----------------+----------+------------------------------------------------+
| DATA_FIELD | 0x11     | 2-16            | 0x0[X17] | X17 - младная тетрада 1-го байта CAN сообщения |
|            |          |                 | ...      |                                                |
|            |          |                 | 0x0[X32] | X18 - старшая тетрада 1-го байта CAN сообщения |
|            |          |                 |          |                                                |
|            |          |                 |          | ...                                            |
|            |          |                 |          |                                                |
|            |          |                 |          | X31 - младная тетрада 8-го байта CAN сообщения |
|            |          |                 |          |                                                |
|            |          |                 |          | X32 - старшая тетрада 8-го байта CAN сообщения |
+------------+----------+-----------------+----------+------------------------------------------------+

Описание модулей ПО
===================

Подсистема хранения данных
--------------------------

Использовать программный RAID1 в linux.

Сервер доставщик сообщений UART
-------------------------------

UART пакеты преобразуются в JSON.




Основной веб-сервер
-------------------

`stream` - поток в стиле server side events
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

POST /new_client
~~~~~~~~~~~~~~~~

POST /set_settings
~~~~~~~~~~~~~~~~~~



ПО терминала
------------

ПО контроллера ПУ
-----------------

